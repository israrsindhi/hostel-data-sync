<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Indus Boys Hostel Management Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #4338ca;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .category-icon {
            display: flex; align-items: center; justify-content: center;
            width: 42px; height: 42px; border-radius: 50%; font-size: 1.2rem;
        }
        
        .tab-indicator {
            position: absolute;
            left: 0.25rem;
            top: 0.25rem;
            bottom: 0.25rem;
            width: calc(33.333% - 8px);
            background: var(--primary-color);
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        
        .login-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c3aed 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
            max-width: 420px;
            width: 100%;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-overlay {
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            animation: slideUp 0.4s ease;
        }
        
        .profile-image-upload {
            position: relative;
            cursor: pointer;
        }
        
        .profile-image-upload:hover .profile-overlay {
            opacity: 1;
        }
        
        .profile-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .theme-indigo { --primary-color: #4f46e5; --primary-dark: #4338ca; }
        .theme-green { --primary-color: #10b981; --primary-dark: #059669; }
        .theme-purple { --primary-color: #7c3aed; --primary-dark: #6d28d9; }
        .theme-blue { --primary-color: #3b82f6; --primary-dark: #2563eb; }
        .theme-orange { --primary-color: #f59e0b; --primary-dark: #d97706; }
        
        .filter-active {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }
        
        .scrollable-modal {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .scrollable-profile {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .scrollable-profile::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-profile::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .scrollable-profile::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .scrollable-profile::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .collection-summary-card {
            transition: all 0.3s ease;
            border-left: 4px solid;
        }
        
        .collection-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="text-slate-800">
    <!-- Login Screen -->
    <div id="login-screen" class="login-bg">
        <!-- ... Login screen code remains exactly the same as before ... -->
        <div class="login-card">
            <div class="bg-indigo-600 text-white p-8 text-center">
                <div class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-building-columns text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold">Indus Boys Hostel</h1>
                <p class="text-indigo-200 text-sm mt-1">Management Portal v2.1</p>
            </div>
            
            <div class="p-8">
                <h2 class="text-xl font-bold text-slate-800 mb-1">Secure Access Portal</h2>
                <p class="text-slate-500 text-sm mb-6">Enter your credentials to continue</p>
                
                <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                            <i class="fa-solid fa-user mr-1"></i>Username
                        </label>
                        <input type="text" id="login-username" required 
                               class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800"
                               placeholder="Enter your username"
                               autocomplete="username">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                            <i class="fa-solid fa-lock mr-1"></i>Password
                        </label>
                        <div class="relative">
                            <input type="password" id="login-password" required 
                                   class="w-full px-4 pr-12 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800"
                                   placeholder="Enter your password"
                                   autocomplete="current-password">
                            <button type="button" onclick="togglePassword()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between pt-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="remember-me" class="w-4 h-4 text-indigo-600 rounded border-slate-300">
                            <span class="text-sm text-slate-600">Remember this device</span>
                        </label>
                    </div>
                    
                    <button type="submit" id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition-all mt-6">
                        <i class="fa-solid fa-right-to-bracket mr-2"></i>Sign In to Dashboard
                    </button>
                </form>
                
                <div id="login-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm text-center">
                    <i class="fa-solid fa-circle-exclamation mr-2"></i>
                    <span id="error-text">Invalid username or password</span>
                </div>
                
                <div class="mt-8 pt-6 border-t border-slate-100">
                    <p class="text-xs text-slate-500 text-center">
                        <i class="fa-solid fa-shield mr-1"></i>
                        Secure access • Encrypted connection • Activity logged
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="hidden h-[100dvh] flex flex-col overflow-hidden bg-slate-50">
        <!-- Header -->
        <header class="bg-indigo-600 text-white shadow-md z-30 shrink-0">
            <div class="w-full max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="fa-solid fa-building-columns text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold">Indus Boys Hostel</h1>
                        <p class="text-indigo-200 text-xs">Management Portal v2.1</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full">
                        <i class="fa-solid fa-calendar-day text-xs"></i>
                        <span class="text-sm" id="current-date"></span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <div class="text-right hidden md:block">
                            <div class="text-sm font-medium" id="welcome-user"></div>
                            <div class="text-indigo-200 text-xs" id="user-role"></div>
                        </div>
                        
                        <div class="relative group">
                            <button onclick="toggleProfileMenu()" class="w-10 h-10 rounded-full overflow-hidden border-2 border-white/30 hover:border-white transition">
                                <img id="user-avatar" src="" alt="Profile" class="w-full h-full object-cover">
                            </button>
                            
                            <!-- Profile Dropdown -->
                            <div id="profile-menu" class="hidden absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-100 py-2 z-50">
                                <div class="px-4 py-3 border-b border-slate-100">
                                    <div class="font-medium text-slate-800 text-sm" id="dropdown-name"></div>
                                    <div class="text-slate-500 text-xs" id="dropdown-role"></div>
                                </div>
                                <button onclick="openProfileSettings()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                    <i class="fa-solid fa-user-gear text-slate-500"></i>
                                    <span>Profile Settings</span>
                                </button>
                                <button onclick="toggleThemeMenu()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                    <i class="fa-solid fa-palette text-slate-500"></i>
                                    <span>Change Theme</span>
                                </button>
                                <!-- Admin Only: Fee Collection Summary -->
                                <div id="admin-features" class="hidden border-t border-slate-100 mt-2 pt-2">
                                    <button onclick="generateFeeCollectionSummary()" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                        <i class="fa-solid fa-file-invoice-dollar text-green-500"></i>
                                        <span>Fee Collection Summary</span>
                                    </button>
                                </div>
                                <div class="border-t border-slate-100 mt-2 pt-2">
                                    <button onclick="handleLogout()" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                        <i class="fa-solid fa-right-from-bracket"></i>
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto w-full max-w-6xl mx-auto">
            <!-- Loading State -->
            <div id="loading-state" class="p-6">
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center mb-4">
                        <i class="fa-solid fa-spinner fa-spin text-indigo-600 text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-slate-700 mb-2">Loading Dashboard</h3>
                    <p class="text-sm text-slate-500">Fetching latest hostel data...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden p-6">
                <div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center max-w-md mx-auto">
                    <i class="fa-solid fa-triangle-exclamation text-red-500 text-4xl mb-4"></i>
                    <h3 class="font-bold text-red-700 mb-2">Connection Error</h3>
                    <p class="text-red-600 text-sm mb-4" id="error-message"></p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="loadData()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fa-solid fa-rotate"></i>
                            <span>Retry</span>
                        </button>
                        <button onclick="useOfflineData()" class="bg-slate-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-slate-700 transition flex items-center gap-2">
                            <i class="fa-solid fa-wifi-slash"></i>
                            <span>Use Offline Data</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="content-area" class="hidden">
                <!-- Quick Stats Row -->
                <div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="stat-card bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold" id="total-income">Rs 0</div>
                                <div class="text-indigo-100 text-sm mt-1">Total Income</div>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <i class="fa-solid fa-arrow-down text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-indigo-200">
                            <i class="fa-solid fa-calendar mr-1"></i>
                            <span id="income-period">This Month</span>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-red-500 to-red-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold" id="total-expense">Rs 0</div>
                                <div class="text-red-100 text-sm mt-1">Total Expenses</div>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <i class="fa-solid fa-arrow-up text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-red-200">
                            <i class="fa-solid fa-calendar mr-1"></i>
                            <span id="expense-period">This Month</span>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold" id="net-balance">Rs 0</div>
                                <div class="text-green-100 text-sm mt-1">Net Balance</div>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <i class="fa-solid fa-scale-balanced text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-green-200">
                            <i class="fa-solid fa-chart-line mr-1"></i>
                            <span id="balance-trend">Positive</span>
                        </div>
                    </div>
                    
                    <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-2xl font-bold" id="total-transactions">0</div>
                                <div class="text-purple-100 text-sm mt-1">Transactions</div>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <i class="fa-solid fa-receipt text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-purple-200">
                            <i class="fa-solid fa-users mr-1"></i>
                            <span id="active-students">0 Students</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div id="filter-section" class="px-4 mb-4">
                    <!-- Filter Toggle -->
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-slate-700">Filters</h3>
                        <button onclick="toggleFilters()" class="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-800">
                            <i class="fa-solid fa-filter"></i>
                            <span id="filter-toggle-text">Show Filters</span>
                        </button>
                    </div>
                    
                    <!-- Filter Panel -->
                    <div id="filter-panel" class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-4">
                        <!-- Category Filters -->
                        <div>
                            <h4 class="font-medium text-slate-700 mb-2 text-sm">Filter by Category</h4>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="toggleCategoryFilter('All')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition filter-active" data-category="All">
                                    All Categories
                                </button>
                                <!-- Fee Categories -->
                                <button onclick="toggleCategoryFilter('Monthly Fee')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Monthly Fee" data-type="fee">
                                    <i class="fa-solid fa-calendar-check mr-1"></i>Monthly Fee
                                </button>
                                <button onclick="toggleCategoryFilter('Security')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Security" data-type="fee">
                                    <i class="fa-solid fa-shield-halved mr-1"></i>Security
                                </button>
                                <button onclick="toggleCategoryFilter('Admission')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Admission" data-type="fee">
                                    <i class="fa-solid fa-id-card mr-1"></i>Admission
                                </button>
                                <!-- Expense Categories -->
                                <button onclick="toggleCategoryFilter('Food')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Food" data-type="expense">
                                    <i class="fa-solid fa-utensils mr-1"></i>Food
                                </button>
                                <button onclick="toggleCategoryFilter('Utilities')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Utilities" data-type="expense">
                                    <i class="fa-solid fa-bolt mr-1"></i>Utilities
                                </button>
                                <button onclick="toggleCategoryFilter('Staff Salary')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Staff Salary" data-type="expense">
                                    <i class="fa-solid fa-users mr-1"></i>Staff Salary
                                </button>
                                <button onclick="toggleCategoryFilter('Transport')" class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-category="Transport" data-type="expense">
                                    <i class="fa-solid fa-bus mr-1"></i>Transport
                                </button>
                            </div>
                        </div>
                        
                        <!-- Collector Filters (Only in Fees Tab) -->
                        <div id="collector-filter-section" class="hidden">
                            <h4 class="font-medium text-slate-700 mb-2 text-sm">Filter by Collector</h4>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="toggleCollectorFilter('All Collectors')" class="collector-filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition filter-active" data-collector="All Collectors">
                                    All Collectors
                                </button>
                                <button onclick="toggleCollectorFilter('Ali Faheem')" class="collector-filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-collector="Ali Faheem">
                                    <i class="fa-solid fa-user-tie mr-1"></i>Ali Faheem
                                </button>
                                <button onclick="toggleCollectorFilter('Faiq Ali')" class="collector-filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-collector="Faiq Ali">
                                    <i class="fa-solid fa-user-tie mr-1"></i>Faiq Ali
                                </button>
                                <button onclick="toggleCollectorFilter('Saeed BAPAR')" class="collector-filter-btn px-3 py-1.5 rounded-full text-xs font-medium border border-slate-200 bg-white text-slate-600 hover:bg-slate-50 transition" data-collector="Saeed BAPAR">
                                    <i class="fa-solid fa-user-tie mr-1"></i>Saeed BAPAR
                                </button>
                            </div>
                        </div>
                        
                        <!-- Clear Filters Button -->
                        <div class="pt-2 border-t border-slate-100">
                            <button onclick="clearAllFilters()" class="text-xs text-slate-500 hover:text-slate-700 flex items-center gap-1">
                                <i class="fa-solid fa-broom"></i>
                                Clear All Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column - Tabs & Transactions -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Tabs Navigation -->
                        <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                            <div class="flex bg-slate-100 rounded-xl p-1 relative">
                                <div id="tab-indicator" class="tab-indicator"></div>
                                
                                <button onclick="switchTab('all')" id="tab-all" class="relative z-10 flex-1 py-3 text-sm font-semibold text-center transition-colors rounded-lg text-white">
                                    <i class="fa-solid fa-list mr-2"></i>All
                                </button>
                                
                                <button onclick="switchTab('fees')" id="tab-fees" class="relative z-10 flex-1 py-3 text-sm font-semibold text-center transition-colors rounded-lg text-slate-500">
                                    <i class="fa-solid fa-money-bill-wave mr-2"></i>Fees
                                </button>
                                
                                <button onclick="switchTab('expenses')" id="tab-expenses" class="relative z-10 flex-1 py-3 text-sm font-semibold text-center transition-colors rounded-lg text-slate-500">
                                    <i class="fa-solid fa-cart-shopping mr-2"></i>Expenses
                                </button>
                            </div>
                        </div>

                        <!-- Transaction Lists -->
                        <div>
                            <!-- All Transactions Tab -->
                            <div id="tab-all-content" class="tab-content active space-y-3">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="font-bold text-slate-800 text-lg">Recent Transactions</h2>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-slate-400 font-medium" id="all-count">0 Records</span>
                                        <button onclick="refreshData()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition">
                                            <i class="fa-solid fa-rotate text-sm text-slate-600"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="all-transactions" class="space-y-3"></div>
                            </div>

                            <!-- Fees Tab -->
                            <div id="tab-fees-content" class="tab-content space-y-3">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="font-bold text-slate-800 text-lg">Fee Collections</h2>
                                    <span class="text-xs text-slate-400 font-medium" id="fees-count">0 Records</span>
                                </div>
                                <div id="fees-transactions" class="space-y-3"></div>
                            </div>

                            <!-- Expenses Tab -->
                            <div id="tab-expenses-content" class="tab-content space-y-3">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="font-bold text-slate-800 text-lg">Expense Records</h2>
                                    <span class="text-xs text-slate-400 font-medium" id="expenses-count">0 Records</span>
                                </div>
                                <div id="expenses-transactions" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Profile & Insights -->
                    <div class="space-y-6">
                        <!-- Profile Card -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-slate-800">Your Profile</h3>
                                <button onclick="openProfileSettings()" class="text-xs text-indigo-600 hover:text-indigo-700 font-medium">
                                    <i class="fa-solid fa-pen mr-1"></i>Edit
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    <img id="profile-avatar" src="" alt="Profile" class="w-16 h-16 rounded-full object-cover border-2 border-slate-200">
                                    <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-full bg-green-500 border-2 border-white flex items-center justify-center">
                                        <i class="fa-solid fa-check text-xs text-white"></i>
                                    </div>
                                </div>
                                
                                <div class="flex-1">
                                    <h4 class="font-bold text-slate-800" id="profile-name">Loading...</h4>
                                    <p class="text-slate-500 text-sm" id="profile-role">Role</p>
                                    <p class="text-slate-400 text-xs mt-1" id="profile-department">Department</p>
                                </div>
                            </div>
                            
                            <div class="mt-4 grid grid-cols-2 gap-3">
                                <div class="text-center p-3 bg-slate-50 rounded-lg">
                                    <div class="text-slate-500 text-xs">Joined</div>
                                    <div class="font-medium text-sm mt-1" id="profile-joined">2025</div>
                                </div>
                                <div class="text-center p-3 bg-slate-50 rounded-lg">
                                    <div class="text-slate-500 text-xs">Sessions</div>
                                    <div class="font-medium text-sm mt-1" id="profile-sessions">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Insights -->
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl p-5">
                            <h3 class="font-bold text-lg mb-4">Quick Insights</h3>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                                            <i class="fa-solid fa-user-graduate"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm">Top Student</div>
                                            <div class="font-bold" id="insight-top-student">-</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-green-400" id="insight-top-amount">Rs 0</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                                            <i class="fa-solid fa-chart-pie"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm">Largest Category</div>
                                            <div class="font-bold" id="insight-top-category">-</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-blue-400" id="insight-category-amount">Rs 0</div>
                                    </div>
                                </div>
                                
                                <div class="pt-3 border-t border-white/10">
                                    <div class="flex items-center gap-2 text-sm">
                                        <i class="fa-solid fa-circle-info"></i>
                                        <span>Data updated: </span>
                                        <span class="font-medium" id="data-updated">Just now</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-slate-200 p-4 text-center text-xs text-slate-500 shrink-0">
            <div class="max-w-6xl mx-auto">
                <p class="mb-1">Indus Boys Hostel Management Portal v2.1 © 2025 • Secure Access Only</p>
                <p class="text-slate-400">
                    <i class="fa-solid fa-location-dot mr-1"></i>
                    <span id="footer-address">Hostel Street, DHA Phase 1, Karachi</span>
                    • 
                    <i class="fa-solid fa-phone mr-1"></i>
                    <span id="footer-contact">0333-1234567</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- Profile Settings Modal (Scrollable) -->
    <div id="profile-modal" class="hidden fixed inset-0 z-50 modal-overlay">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeProfileSettings()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-slate-100 shrink-0">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-slate-800">Profile Settings</h3>
                        <button onclick="closeProfileSettings()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <p class="text-slate-500 text-sm mt-1">Customize your profile (saved locally)</p>
                </div>
                
                <div class="p-6 scrollable-profile">
                    <form id="profile-form" onsubmit="saveProfileSettings(event)" class="space-y-6">
                        <!-- Profile Image -->
                        <div class="text-center">
                            <div class="profile-image-upload inline-block relative">
                                <img id="profile-preview" src="" alt="Profile" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">
                                <div class="profile-overlay">
                                    <i class="fa-solid fa-camera text-white text-xl"></i>
                                </div>
                                <input type="file" id="profile-image-input" accept="image/*" class="hidden" onchange="previewProfileImage(event)">
                            </div>
                            <p class="text-xs text-slate-500 mt-2">Click to change profile image</p>
                        </div>
                        
                        <!-- Personal Info -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label>
                                <input type="text" id="profile-name-input" 
                                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role</label>
                                    <input type="text" id="profile-role-input" 
                                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Department</label>
                                    <input type="text" id="profile-dept-input" 
                                           class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                                <input type="email" id="profile-email-input" 
                                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Phone Number</label>
                                <input type="tel" id="profile-phone-input" 
                                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Signature</label>
                                <input type="text" id="profile-signature-input" 
                                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800"
                                       placeholder="Your official signature">
                            </div>
                        </div>
                        
                        <!-- Preferences -->
                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="font-bold text-slate-700 mb-3">Preferences</h4>
                            
                            <div class="space-y-4">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="profile-notifications" class="w-4 h-4 text-indigo-600 rounded border-slate-300">
                                    <span class="text-sm text-slate-700">Enable email notifications</span>
                                </label>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Theme Color</label>
                                    <div class="flex gap-2 mt-2">
                                        <button type="button" onclick="selectTheme('indigo')" class="theme-option w-8 h-8 rounded-full bg-indigo-500 border-2 border-white shadow"></button>
                                        <button type="button" onclick="selectTheme('green')" class="theme-option w-8 h-8 rounded-full bg-green-500 border-2 border-white shadow"></button>
                                        <button type="button" onclick="selectTheme('purple')" class="theme-option w-8 h-8 rounded-full bg-purple-500 border-2 border-white shadow"></button>
                                        <button type="button" onclick="selectTheme('blue')" class="theme-option w-8 h-8 rounded-full bg-blue-500 border-2 border-white shadow"></button>
                                        <button type="button" onclick="selectTheme('orange')" class="theme-option w-8 h-8 rounded-full bg-orange-500 border-2 border-white shadow"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="pt-6 border-t border-slate-100">
                            <div class="flex gap-3">
                                <button type="button" onclick="resetProfileToDefault()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 rounded-xl transition">
                                    Reset to Default
                                </button>
                                <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-xl transition">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Fee Collection Summary Modal -->
    <div id="fee-summary-modal" class="hidden fixed inset-0 z-[60] modal-overlay">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeFeeSummary()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-slate-100 shrink-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">Fee Collection Summary</h3>
                            <p class="text-slate-500 text-sm mt-1">Analysis of fee collections by collectors</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="printFeeSummary()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition flex items-center gap-2">
                                <i class="fa-solid fa-print"></i>
                                <span class="hidden md:inline">Print</span>
                            </button>
                            <button onclick="exportFeeSummary()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg font-medium transition flex items-center gap-2">
                                <i class="fa-solid fa-download"></i>
                                <span class="hidden md:inline">Export</span>
                            </button>
                            <button onclick="closeFeeSummary()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200 transition">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-indigo-50 p-4 rounded-xl">
                            <div class="text-indigo-600 text-sm font-medium mb-1">Total Collected</div>
                            <div class="text-2xl font-bold text-slate-800" id="summary-total">Rs 0</div>
                            <div class="text-slate-500 text-xs mt-1">From all collectors</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl">
                            <div class="text-green-600 text-sm font-medium mb-1">Collections Count</div>
                            <div class="text-2xl font-bold text-slate-800" id="summary-count">0</div>
                            <div class="text-slate-500 text-xs mt-1">Total fee transactions</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl">
                            <div class="text-purple-600 text-sm font-medium mb-1">Period</div>
                            <div class="text-2xl font-bold text-slate-800" id="summary-period">-</div>
                            <div class="text-slate-500 text-xs mt-1">Reporting period</div>
                        </div>
                    </div>
                    
                    <!-- Collector Breakdown -->
                    <div class="mb-6">
                        <h4 class="font-bold text-slate-700 mb-4">Collector Performance</h4>
                        <div id="collector-breakdown" class="space-y-4">
                            <!-- Collector cards will be generated here -->
                        </div>
                    </div>
                    
                    <!-- Student Breakdown -->
                    <div class="mb-6">
                        <h4 class="font-bold text-slate-700 mb-4">Student-wise Collections</h4>
                        <div id="student-breakdown" class="space-y-3">
                            <!-- Student details will be generated here -->
                        </div>
                    </div>
                    
                    <!-- Category Breakdown -->
                    <div>
                        <h4 class="font-bold text-slate-700 mb-4">Category-wise Breakdown</h4>
                        <div id="category-breakdown" class="space-y-3">
                            <!-- Category details will be generated here -->
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-slate-100 bg-slate-50 text-center text-xs text-slate-500">
                    <p>Generated on <span id="summary-generated-date"></span> • Indus Boys Hostel Management System</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            STORAGE_KEYS: {
                USER_SESSION: 'indus_hostel_user_session_v2',
                USER_PROFILE: 'indus_hostel_user_profile_',
                APP_SETTINGS: 'indus_hostel_app_settings'
            },
            SESSION_TIMEOUT: 30 * 24 * 60 * 60 * 1000, // 30 days
            DATA_REFRESH_INTERVAL: 5 * 60 * 1000, // 5 minutes
            THEMES: {
                indigo: { primary: '#4f46e5', dark: '#4338ca' },
                green: { primary: '#10b981', dark: '#059669' },
                purple: { primary: '#7c3aed', dark: '#6d28d9' },
                blue: { primary: '#3b82f6', dark: '#2563eb' },
                orange: { primary: '#f59e0b', dark: '#d97706' }
            },
            COLLECTORS: ['Ali Faheem', 'Faiq Ali', 'Saeed BAPAR']
        };

        // ========== APP STATE ==========
        let currentUser = null;
        let userProfile = null;
        let jsonData = null;
        let currentTab = 'all';
        let activeFilters = {
            category: 'All',
            collector: 'All Collectors'
        };
        let feeTransactions = [];

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            updateCurrentDate();
            await checkExistingSession();
            setInterval(updateDataUpdatedTime, 60000);
        });

        // ========== SESSION MANAGEMENT ==========
        async function checkExistingSession() {
            try {
                const savedSession = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_SESSION);
                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    const now = Date.now();
                    
                    if (session.expiresAt && now < session.expiresAt) {
                        currentUser = session.user;
                        await loadUserProfile();
                        showApp();
                        trackSessionActivity();
                        return;
                    } else {
                        localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_SESSION);
                    }
                }
            } catch (error) {
                console.error('Session check error:', error);
                clearUserSession();
            }
            
            showLogin();
        }

        function trackSessionActivity() {
            if (!currentUser) return;
            
            const activityKey = `session_activity_${currentUser.username}`;
            const savedActivity = localStorage.getItem(activityKey);
            let sessionActivity = savedActivity ? JSON.parse(savedActivity) : { loginCount: 0 };
            
            sessionActivity.loginCount = (sessionActivity.loginCount || 0) + 1;
            sessionActivity.lastActivity = Date.now();
            
            localStorage.setItem(activityKey, JSON.stringify(sessionActivity));
            
            if (document.getElementById('profile-sessions')) {
                document.getElementById('profile-sessions').textContent = sessionActivity.loginCount;
            }
        }

        // ========== LOGIN / LOGOUT ==========
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Authenticating...';
            loginBtn.disabled = true;
            
            try {
                const response = await fetch('profiles_data.json');
                if (!response.ok) throw new Error('Network error');
                
                const credentials = await response.json();
                const user = credentials.users.find(u => 
                    u.username.toLowerCase() === username.toLowerCase() && 
                    u.password === password
                );
                
                if (user) {
                    currentUser = {
                        username: user.username,
                        defaultProfile: user.defaultProfile,
                        role: user.defaultProfile.role
                    };
                    
                    const session = {
                        user: currentUser,
                        expiresAt: rememberMe ? Date.now() + CONFIG.SESSION_TIMEOUT : null,
                        createdAt: Date.now()
                    };
                    
                    localStorage.setItem(CONFIG.STORAGE_KEYS.USER_SESSION, JSON.stringify(session));
                    await loadUserProfile();
                    showApp();
                    trackSessionActivity();
                    
                } else {
                    showLoginError('Invalid username or password');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Network error. Please try again.');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                clearUserSession();
                showLogin();
            }
        }

        function clearUserSession() {
            localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_SESSION);
            currentUser = null;
            userProfile = null;
        }

        // ========== PROFILE MANAGEMENT ==========
        async function loadUserProfile() {
            if (!currentUser) return;
            
            const profileKey = CONFIG.STORAGE_KEYS.USER_PROFILE + currentUser.username;
            const savedProfile = localStorage.getItem(profileKey);
            
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
            } else {
                userProfile = { ...currentUser.defaultProfile };
                userProfile.isDefault = true;
                userProfile.createdAt = Date.now();
                localStorage.setItem(profileKey, JSON.stringify(userProfile));
            }
            
            // Show admin features if user is admin
            if (currentUser.role === 'System Admin' || currentUser.username === 'admin') {
                document.getElementById('admin-features').classList.remove('hidden');
            }
            
            applyTheme(userProfile.theme || 'indigo');
            updateProfileUI();
        }

        function updateProfileUI() {
            if (!userProfile) return;
            
            document.getElementById('welcome-user').textContent = userProfile.name;
            document.getElementById('user-role').textContent = userProfile.role;
            document.getElementById('dropdown-name').textContent = userProfile.name;
            document.getElementById('dropdown-role').textContent = userProfile.role;
            
            const avatarElements = document.querySelectorAll('#user-avatar, #profile-avatar, #profile-preview');
            avatarElements.forEach(el => {
                el.src = userProfile.image || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userProfile.name) + '&background=4f46e5&color=fff&size=128';
            });
            
            document.getElementById('profile-name').textContent = userProfile.name;
            document.getElementById('profile-role').textContent = userProfile.role;
            document.getElementById('profile-department').textContent = userProfile.department || 'Not specified';
            document.getElementById('profile-joined').textContent = new Date(userProfile.createdAt).getFullYear();
            
            document.getElementById('footer-address').textContent = jsonData?.metadata?.address || 'Hostel Street, DHA Phase 1, Karachi';
            document.getElementById('footer-contact').textContent = jsonData?.metadata?.contact || '0333-1234567';
        }

        // ========== PROFILE SETTINGS MODAL ==========
        function openProfileSettings() {
            if (!userProfile) return;
            
            document.getElementById('profile-name-input').value = userProfile.name;
            document.getElementById('profile-role-input').value = userProfile.role;
            document.getElementById('profile-dept-input').value = userProfile.department || '';
            document.getElementById('profile-email-input').value = userProfile.email || '';
            document.getElementById('profile-phone-input').value = userProfile.phone || '';
            document.getElementById('profile-signature-input').value = userProfile.signature || '';
            document.getElementById('profile-notifications').checked = userProfile.notifications !== false;
            document.getElementById('profile-preview').src = userProfile.image;
            
            const theme = userProfile.theme || 'indigo';
            document.querySelectorAll('.theme-option').forEach(btn => {
                const btnTheme = btn.onclick.toString().match(/'([^']+)'/)[1];
                btn.classList.toggle('border-4', btnTheme === theme);
                btn.classList.toggle('border-2', btnTheme !== theme);
            });
            
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-menu').classList.add('hidden');
        }

        function closeProfileSettings() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        function saveProfileSettings(event) {
            event.preventDefault();
            
            if (!userProfile || !currentUser) return;
            
            userProfile.name = document.getElementById('profile-name-input').value;
            userProfile.role = document.getElementById('profile-role-input').value;
            userProfile.department = document.getElementById('profile-dept-input').value;
            userProfile.email = document.getElementById('profile-email-input').value;
            userProfile.phone = document.getElementById('profile-phone-input').value;
            userProfile.signature = document.getElementById('profile-signature-input').value;
            userProfile.notifications = document.getElementById('profile-notifications').checked;
            userProfile.updatedAt = Date.now();
            userProfile.isDefault = false;
            
            const activeThemeBtn = document.querySelector('.theme-option.border-4');
            if (activeThemeBtn) {
                const theme = activeThemeBtn.onclick.toString().match(/'([^']+)'/)[1];
                userProfile.theme = theme;
            }
            
            const imageInput = document.getElementById('profile-image-input');
            if (imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userProfile.image = e.target.result;
                    saveProfileToStorage();
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                saveProfileToStorage();
            }
            
            function saveProfileToStorage() {
                const profileKey = CONFIG.STORAGE_KEYS.USER_PROFILE + currentUser.username;
                localStorage.setItem(profileKey, JSON.stringify(userProfile));
                updateProfileUI();
                applyTheme(userProfile.theme || 'indigo');
                alert('Profile updated successfully! Changes saved locally.');
                closeProfileSettings();
            }
        }

        // ========== FILTER SYSTEM ==========
        function toggleFilters() {
            const panel = document.getElementById('filter-panel');
            const toggleText = document.getElementById('filter-toggle-text');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                toggleText.textContent = 'Hide Filters';
            } else {
                panel.classList.add('hidden');
                toggleText.textContent = 'Show Filters';
            }
        }

        function toggleCategoryFilter(category) {
            // Update active filter
            activeFilters.category = category;
            
            // Update UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('filter-active');
                } else {
                    btn.classList.remove('filter-active');
                }
            });
            
            // Refresh transaction lists
            refreshTransactionLists();
        }

        function toggleCollectorFilter(collector) {
            activeFilters.collector = collector;
            
            document.querySelectorAll('.collector-filter-btn').forEach(btn => {
                if (btn.dataset.collector === collector) {
                    btn.classList.add('filter-active');
                } else {
                    btn.classList.remove('filter-active');
                }
            });
            
            refreshTransactionLists();
        }

        function clearAllFilters() {
            activeFilters = {
                category: 'All',
                collector: 'All Collectors'
            };
            
            // Reset UI
            document.querySelectorAll('.filter-btn, .collector-filter-btn').forEach(btn => {
                if (btn.dataset.category === 'All' || btn.dataset.collector === 'All Collectors') {
                    btn.classList.add('filter-active');
                } else {
                    btn.classList.remove('filter-active');
                }
            });
            
            refreshTransactionLists();
        }

        // ========== TAB SYSTEM ==========
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab indicator
            const positions = { 'all': 'translateX(0)', 'fees': 'translateX(100%)', 'expenses': 'translateX(200%)' };
            document.getElementById('tab-indicator').style.transform = positions[tabName];
            
            // Update tab buttons
            const tabs = ['all', 'fees', 'expenses'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                if (tab === tabName) {
                    btn.classList.remove('text-slate-500');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.remove('text-white');
                    btn.classList.add('text-slate-500');
                }
            });
            
            // Show/hide collector filters
            const collectorSection = document.getElementById('collector-filter-section');
            if (tabName === 'fees') {
                collectorSection.classList.remove('hidden');
            } else {
                collectorSection.classList.add('hidden');
                activeFilters.collector = 'All Collectors';
            }
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}-content`).classList.add('active');
            
            refreshTransactionLists();
        }

        // ========== DATA MANAGEMENT ==========
        async function loadData() {
            try {
                showLoading(true);
                
                const response = await fetch('data.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                jsonData = await response.json();
                
                // Extract fee transactions for analysis
                feeTransactions = jsonData.transactions.filter(t => t.type === 'fee');
                
                renderData();
                showContent();
                showLoading(false);
                
            } catch (error) {
                console.error('Data loading error:', error);
                showError('Failed to load data', error.message);
            }
        }

        function renderData() {
            if (!jsonData) return;
            
            localStorage.setItem('offline_data', JSON.stringify(jsonData));
            
            const feeTransactions = jsonData.transactions.filter(t => t.type === 'fee');
            const expenseTransactions = jsonData.transactions.filter(t => t.type === 'expense');
            
            const totalIncome = feeTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = expenseTransactions.reduce((sum, t) => sum + t.amount, 0);
            const netBalance = totalIncome - totalExpense;
            
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('net-balance').textContent = formatCurrency(netBalance);
            document.getElementById('total-transactions').textContent = jsonData.transactions.length;
            
            document.getElementById('income-period').textContent = jsonData.metadata.reportPeriod;
            document.getElementById('expense-period').textContent = jsonData.metadata.reportPeriod;
            document.getElementById('balance-trend').textContent = netBalance >= 0 ? 'Positive' : 'Negative';
            
            const uniqueStudents = [...new Set(feeTransactions.map(t => t.studentName).filter(Boolean))];
            document.getElementById('active-students').textContent = `${uniqueStudents.length} Students`;
            
            updateInsights(feeTransactions, expenseTransactions);
            refreshTransactionLists();
            updateDataUpdatedTime();
        }

        function refreshTransactionLists() {
            if (!jsonData) return;
            
            let filteredTransactions = [...jsonData.transactions];
            
            // Apply category filter
            if (activeFilters.category !== 'All') {
                filteredTransactions = filteredTransactions.filter(t => t.category === activeFilters.category);
            }
            
            // Apply tab filter
            if (currentTab === 'fees') {
                filteredTransactions = filteredTransactions.filter(t => t.type === 'fee');
                
                // Apply collector filter for fees tab
                if (activeFilters.collector !== 'All Collectors') {
                    filteredTransactions = filteredTransactions.filter(t => t.collectedBy === activeFilters.collector);
                }
            } else if (currentTab === 'expenses') {
                filteredTransactions = filteredTransactions.filter(t => t.type === 'expense');
            }
            
            // Update counts
            const feeCount = jsonData.transactions.filter(t => t.type === 'fee').length;
            const expenseCount = jsonData.transactions.filter(t => t.type === 'expense').length;
            
            document.getElementById('all-count').textContent = `${filteredTransactions.length} Records`;
            document.getElementById('fees-count').textContent = `${feeCount} Records`;
            document.getElementById('expenses-count').textContent = `${expenseCount} Records`;
            
            // Render appropriate list
            if (currentTab === 'all') {
                renderTransactionList('all-transactions', filteredTransactions);
            } else if (currentTab === 'fees') {
                const feeList = filteredTransactions.filter(t => t.type === 'fee');
                renderTransactionList('fees-transactions', feeList);
            } else if (currentTab === 'expenses') {
                const expenseList = filteredTransactions.filter(t => t.type === 'expense');
                renderTransactionList('expenses-transactions', expenseList);
            }
        }

        function renderTransactionList(containerId, transactions) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = getEmptyStateHTML('No transactions found');
                return;
            }
            
            const sortedTransactions = [...transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedTransactions.forEach(transaction => {
                container.appendChild(createTransactionCard(transaction));
            });
        }

        // ========== FEE COLLECTION SUMMARY ==========
        function generateFeeCollectionSummary() {
            if (!jsonData || !feeTransactions.length) {
                alert('No fee data available to generate summary.');
                return;
            }
            
            // Calculate totals
            const totalCollected = feeTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            // Group by collector
            const collectorData = {};
            CONFIG.COLLECTORS.forEach(collector => {
                collectorData[collector] = {
                    total: 0,
                    transactions: [],
                    students: {}
                };
            });
            
            feeTransactions.forEach(transaction => {
                const collector = transaction.collectedBy;
                if (collector && collectorData[collector]) {
                    collectorData[collector].total += transaction.amount;
                    collectorData[collector].transactions.push(transaction);
                    
                    // Group by student for this collector
                    if (!collectorData[collector].students[transaction.studentName]) {
                        collectorData[collector].students[transaction.studentName] = 0;
                    }
                    collectorData[collector].students[transaction.studentName] += transaction.amount;
                }
            });
            
            // Group by category
            const categoryData = {};
            feeTransactions.forEach(transaction => {
                if (!categoryData[transaction.category]) {
                    categoryData[transaction.category] = 0;
                }
                categoryData[transaction.category] += transaction.amount;
            });
            
            // Update summary modal
            document.getElementById('summary-total').textContent = formatCurrency(totalCollected);
            document.getElementById('summary-count').textContent = feeTransactions.length;
            document.getElementById('summary-period').textContent = jsonData.metadata.reportPeriod;
            document.getElementById('summary-generated-date').textContent = new Date().toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Render collector breakdown
            const collectorContainer = document.getElementById('collector-breakdown');
            collectorContainer.innerHTML = '';
            
            CONFIG.COLLECTORS.forEach(collector => {
                const data = collectorData[collector];
                const card = document.createElement('div');
                card.className = 'collection-summary-card bg-white p-4 rounded-xl border border-slate-100 shadow-sm';
                card.style.borderLeftColor = getCollectorColor(collector);
                
                const studentCount = Object.keys(data.students).length;
                const transactionCount = data.transactions.length;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-bold text-slate-800">${collector}</h5>
                            <div class="flex items-center gap-4 mt-2 text-sm text-slate-600">
                                <span><i class="fa-solid fa-money-bill-wave mr-1"></i>${formatCurrency(data.total)}</span>
                                <span><i class="fa-solid fa-receipt mr-1"></i>${transactionCount} transactions</span>
                                <span><i class="fa-solid fa-user-graduate mr-1"></i>${studentCount} students</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${data.total > 0 ? 'text-green-600' : 'text-slate-400'}">
                                ${formatCurrency(data.total)}
                            </div>
                            <div class="text-xs text-slate-500">Total Collected</div>
                        </div>
                    </div>
                    ${studentCount > 0 ? `
                    <div class="mt-3 pt-3 border-t border-slate-100">
                        <div class="text-xs text-slate-500 mb-2">Student-wise Breakdown:</div>
                        <div class="grid grid-cols-2 gap-2">
                            ${Object.entries(data.students).map(([student, amount]) => `
                                <div class="text-sm">
                                    <span class="text-slate-700">${student}</span>
                                    <span class="float-right font-medium">${formatCurrency(amount)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
                
                collectorContainer.appendChild(card);
            });
            
            // Render category breakdown
            const categoryContainer = document.getElementById('category-breakdown');
            categoryContainer.innerHTML = Object.entries(categoryData)
                .sort(([,a], [,b]) => b - a)
                .map(([category, amount]) => `
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                        <span class="font-medium text-slate-700">${category}</span>
                        <span class="font-bold text-green-600">${formatCurrency(amount)}</span>
                    </div>
                `).join('');
            
            // Show modal
            document.getElementById('fee-summary-modal').classList.remove('hidden');
            document.getElementById('profile-menu').classList.add('hidden');
        }

        function closeFeeSummary() {
            document.getElementById('fee-summary-modal').classList.add('hidden');
        }

        function printFeeSummary() {
            const printContent = document.getElementById('fee-summary-modal').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h1 style="color: #4f46e5; border-bottom: 2px solid #4f46e5; padding-bottom: 10px;">
                        Fee Collection Summary - Indus Boys Hostel
                    </h1>
                    <div style="margin-top: 20px;">
                        ${document.getElementById('fee-summary-modal').querySelector('.modal-content').innerHTML}
                    </div>
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }

        function exportFeeSummary() {
            if (!jsonData) return;
            
            const feeData = jsonData.transactions.filter(t => t.type === 'fee');
            const summary = {
                generated: new Date().toISOString(),
                period: jsonData.metadata.reportPeriod,
                totalCollected: feeData.reduce((sum, t) => sum + t.amount, 0),
                totalTransactions: feeData.length,
                collectors: {},
                students: {},
                categories: {}
            };
            
            // Group data
            feeData.forEach(transaction => {
                // By collector
                if (transaction.collectedBy) {
                    if (!summary.collectors[transaction.collectedBy]) {
                        summary.collectors[transaction.collectedBy] = {
                            total: 0,
                            transactions: []
                        };
                    }
                    summary.collectors[transaction.collectedBy].total += transaction.amount;
                    summary.collectors[transaction.collectedBy].transactions.push({
                        student: transaction.studentName,
                        amount: transaction.amount,
                        date: transaction.date,
                        category: transaction.category
                    });
                }
                
                // By student
                if (transaction.studentName) {
                    if (!summary.students[transaction.studentName]) {
                        summary.students[transaction.studentName] = 0;
                    }
                    summary.students[transaction.studentName] += transaction.amount;
                }
                
                // By category
                if (!summary.categories[transaction.category]) {
                    summary.categories[transaction.category] = 0;
                }
                summary.categories[transaction.category] += transaction.amount;
            });
            
            // Create CSV
            let csv = 'Fee Collection Summary\n\n';
            csv += 'Period,Total Collected,Total Transactions\n';
            csv += `${summary.period},${summary.totalCollected},${summary.totalTransactions}\n\n`;
            
            csv += 'Collector Breakdown\n';
            csv += 'Collector,Total Collected,Transaction Count\n';
            Object.entries(summary.collectors).forEach(([collector, data]) => {
                csv += `${collector},${data.total},${data.transactions.length}\n`;
            });
            
            csv += '\nStudent-wise Collections\n';
            csv += 'Student,Total Paid\n';
            Object.entries(summary.students).forEach(([student, amount]) => {
                csv += `${student},${amount}\n`;
            });
            
            csv += '\nCategory-wise Breakdown\n';
            csv += 'Category,Total Amount\n';
            Object.entries(summary.categories).forEach(([category, amount]) => {
                csv += `${category},${amount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Fee_Collection_Summary_${jsonData.metadata.reportPeriod.replace(' ', '_')}.csv`;
            a.click();
        }

        // ========== UTILITY FUNCTIONS ==========
        function getCollectorColor(collector) {
            const colors = {
                'Ali Faheem': '#4f46e5',
                'Faiq Ali': '#10b981',
                'Saeed BAPAR': '#7c3aed'
            };
            return colors[collector] || '#6b7280';
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = dateString;
            }
        }

        function applyTheme(theme) {
            const themeColors = CONFIG.THEMES[theme] || CONFIG.THEMES.indigo;
            
            document.documentElement.style.setProperty('--primary-color', themeColors.primary);
            document.documentElement.style.setProperty('--primary-dark', themeColors.dark);
            
            const header = document.querySelector('header');
            if (header) {
                header.style.background = `linear-gradient(135deg, ${themeColors.primary} 0%, ${themeColors.dark} 100%)`;
            }
            
            document.body.classList.remove('theme-indigo', 'theme-green', 'theme-purple', 'theme-blue', 'theme-orange');
            document.body.classList.add(`theme-${theme}`);
        }

        function selectTheme(theme) {
            document.querySelectorAll('.theme-option').forEach(btn => {
                const btnTheme = btn.onclick.toString().match(/'([^']+)'/)[1];
                btn.classList.toggle('border-4', btnTheme === theme);
                btn.classList.toggle('border-2', btnTheme !== theme);
            });
            applyTheme(theme);
        }

        function updateDataUpdatedTime() {
            const element = document.getElementById('data-updated');
            if (element) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                element.textContent = `Today at ${timeString}`;
            }
        }

        function formatCurrency(amount) {
            return `Rs ${amount.toLocaleString()}`;
        }

        function formatDate(dateString, format = 'full') {
            const date = new Date(dateString);
            if (format === 'short') {
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            }
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function getEmptyStateHTML(message) {
            return `
                <div class="flex flex-col items-center justify-center py-12 opacity-60">
                    <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mb-3">
                        <i class="fa-solid fa-clipboard-list text-2xl text-slate-300"></i>
                    </div>
                    <p class="text-sm text-slate-400">${message}</p>
                </div>`;
        }

        function createTransactionCard(transaction) {
            const isFee = transaction.type === 'fee';
            const categories = isFee ? FEE_CATEGORIES : EXPENSE_CATEGORIES;
            const categoryConfig = categories[transaction.category] || 
                                 { icon: 'fa-circle', color: 'bg-gray-100 text-gray-500', label: transaction.category };
            
            const card = document.createElement('div');
            card.className = 'transaction-card bg-white p-4 rounded-2xl shadow-sm border border-slate-100';
            
            let collectorInfo = '';
            if (isFee && transaction.collectedBy) {
                collectorInfo = `
                    <div class="text-xs text-slate-500 mt-1">
                        <i class="fa-solid fa-user-tie mr-1"></i>
                        Collected by: ${transaction.collectedBy}
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="${categoryConfig.color} category-icon">
                            <i class="fa-solid ${categoryConfig.icon}"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h4 class="font-semibold text-slate-800 text-sm truncate leading-tight">
                                ${transaction.description}
                            </h4>
                            <div class="text-xs text-slate-400 mt-0.5 truncate">
                                <span class="inline-flex items-center gap-1">
                                    <i class="fa-solid fa-calendar"></i>
                                    ${formatDate(transaction.date, 'short')}
                                </span>
                                <span class="mx-2">•</span>
                                ${isFee ? 
                                    `<span><i class="fa-solid fa-user-graduate mr-1"></i>${transaction.studentName}</span>` : 
                                    `<span><i class="fa-solid fa-store mr-1"></i>${transaction.vendor || transaction.category}</span>`
                                }
                            </div>
                            ${collectorInfo}
                            ${transaction.receiptNo || transaction.invoiceNo ? 
                                `<div class="text-xs text-slate-500 mt-1">
                                    <i class="fa-solid fa-hashtag mr-1"></i>
                                    ${transaction.receiptNo || transaction.invoiceNo}
                                </div>` : ''
                            }
                        </div>
                    </div>
                    <div class="flex flex-col items-end shrink-0 pl-2">
                        <span class="font-bold ${isFee ? 'text-green-600' : 'text-red-600'} text-lg">
                            ${isFee ? '+' : '-'} ${formatCurrency(transaction.amount)}
                        </span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs px-2 py-1 rounded-full ${isFee ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${isFee ? 'FEE' : 'EXPENSE'}
                            </span>
                            <span class="text-xs text-slate-500">
                                <i class="fa-solid fa-${transaction.paymentMethod === 'Cash' ? 'money-bill' : 'building-columns'}"></i>
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        const FEE_CATEGORIES = {
            'Monthly Fee': { icon: 'fa-calendar-check', color: 'bg-green-100 text-green-600' },
            'Admission': { icon: 'fa-id-card', color: 'bg-teal-100 text-teal-600' },
            'Security': { icon: 'fa-shield-halved', color: 'bg-indigo-100 text-indigo-600' },
            'Others': { icon: 'fa-money-bill', color: 'bg-gray-100 text-gray-600' }
        };

        const EXPENSE_CATEGORIES = {
            'Food': { icon: 'fa-utensils', color: 'bg-orange-100 text-orange-600' },
            'Rent': { icon: 'fa-house', color: 'bg-blue-100 text-blue-600' },
            'Transport': { icon: 'fa-bus', color: 'bg-purple-100 text-purple-600' },
            'Utilities': { icon: 'fa-bolt', color: 'bg-yellow-100 text-yellow-600' },
            'Staff Salary': { icon: 'fa-users', color: 'bg-cyan-100 text-cyan-600' },
            'Daily Expenses': { icon: 'fa-shopping-bag', color: 'bg-fuchsia-100 text-fuchsia-600' },
            'Others': { icon: 'fa-box-open', color: 'bg-gray-100 text-gray-600' }
        };

        // Initialize
        switchTab('all');
        
        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
            .animate-shake {
                animation: shake 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
